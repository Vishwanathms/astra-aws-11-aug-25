
# **Lab: AWS Lambda Triggered by S3 → SNS Notification → Move File to Another S3 Bucket**

---

## **1. Lab Architecture**

```
[S3 Bucket A: "source-bucket"]
        |
  (S3 Event: ObjectCreated)
        v
[Lambda Function: s3-to-sns-move]
        |       \
        |        \-> [SNS Topic: "file-upload-topic"] → (email subscribers)
        |
        v
[S3 Bucket B: "destination-bucket"]
```

---

## **2. Prerequisites**

* AWS Account
* IAM user/role with permissions for:

  * S3 (`s3:GetObject`, `s3:PutObject`, `s3:DeleteObject`)
  * Lambda (`lambda:*`)
  * SNS (`sns:Publish`, `sns:Subscribe`)
  * CloudWatch Logs (`logs:*`)
* AWS CLI installed & configured
* Python 3.x (if building locally for zip)

---

## **3. Step-by-Step Lab Setup**

### **Step 1 – Create Two S3 Buckets**

```bash
aws s3 mb s3://my-source-bucket-demo-2025
aws s3 mb s3://my-destination-bucket-demo-2025
```

* Ensure names are globally unique.
* `source-bucket` = triggers Lambda
* `destination-bucket` = receives moved file

---

### **Step 2 – Create SNS Topic & Email Subscription**

```bash
aws sns create-topic --name file-upload-topic
SNS_ARN=$(aws sns list-topics --query "Topics[?contains(TopicArn, 'file-upload-topic')].TopicArn" --output text)

aws sns subscribe \
  --topic-arn "$SNS_ARN" \
  --protocol email \
  --notification-endpoint "youremail@example.com"
```

**Check your email** and confirm the subscription before continuing.

---

### **Step 3 – Create IAM Role for Lambda**

```bash
aws iam create-role \
  --role-name lambda-s3-sns-role \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }]
  }'
```

Attach permissions:

```bash
aws iam attach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
aws iam attach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
aws iam attach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/AmazonSNSFullAccess
```

---

### **Step 4 – Write Lambda Function Code**

**`lambda_function.py`**

```python
import json
import boto3
import os
import urllib.parse

s3_client = boto3.client('s3')
sns_client = boto3.client('sns')

DEST_BUCKET = os.environ['DEST_BUCKET']
SNS_TOPIC_ARN = os.environ['SNS_TOPIC_ARN']

def lambda_handler(event, context):
    print("Event:", json.dumps(event))
    
    # Extract bucket and object key from event
    src_bucket = event['Records'][0]['s3']['bucket']['name']
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'])
    
    try:
        # Copy object to destination bucket
        s3_client.copy_object(
            Bucket=DEST_BUCKET,
            CopySource={'Bucket': src_bucket, 'Key': key},
            Key=key
        )
        
        # Delete from source
        s3_client.delete_object(Bucket=src_bucket, Key=key)
        
        # Publish SNS notification
        message = f"File '{key}' moved from '{src_bucket}' to '{DEST_BUCKET}'."
        sns_client.publish(TopicArn=SNS_TOPIC_ARN, Message=message, Subject="S3 File Moved")
        
        return {'statusCode': 200, 'body': json.dumps('File processed successfully')}
    
    except Exception as e:
        print(e)
        raise e
```

---

### **Step 5 – Deploy Lambda Function**

Zip the code:

```bash
zip function.zip lambda_function.py
```

Get Role ARN:

```bash
ROLE_ARN=$(aws iam get-role --role-name lambda-s3-sns-role --query "Role.Arn" --output text)
```

Create Lambda:

```bash
aws lambda create-function \
  --function-name s3-to-sns-move \
  --runtime python3.12 \
  --role $ROLE_ARN \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://function.zip \
  --environment Variables="{DEST_BUCKET=my-destination-bucket-demo-2025,SNS_TOPIC_ARN=$SNS_ARN}"
```

---

### **Step 6 – Create S3 Event Trigger for Lambda**

```bash
aws s3api put-bucket-notification-configuration \
  --bucket my-source-bucket-demo-2025 \
  --notification-configuration '{
    "LambdaFunctionConfigurations": [{
      "LambdaFunctionArn": "'"$(aws lambda get-function --function-name s3-to-sns-move --query "Configuration.FunctionArn" --output text)"'",
      "Events": ["s3:ObjectCreated:*"]
    }]
  }'
```

You also need to give S3 permission to invoke Lambda:

```bash
aws lambda add-permission \
  --function-name s3-to-sns-move \
  --principal s3.amazonaws.com \
  --statement-id s3invoke \
  --action "lambda:InvokeFunction" \
  --source-arn arn:aws:s3:::my-source-bucket-demo-2025
```

---

### **Step 7 – Test the Setup**

Upload a file to source bucket:

```bash
echo "Hello Lambda" > test.txt
aws s3 cp test.txt s3://my-source-bucket-demo-2025/
```

Expected flow:

1. Lambda is triggered
2. File is copied to `destination-bucket`
3. File is deleted from `source-bucket`
4. SNS sends an email notification

Check:

```bash
aws s3 ls s3://my-source-bucket-demo-2025/
aws s3 ls s3://my-destination-bucket-demo-2025/
```

---

### **Step 8 – Cleanup**

```bash
aws s3 rm s3://my-source-bucket-demo-2025 --recursive
aws s3 rm s3://my-destination-bucket-demo-2025 --recursive
aws s3 rb s3://my-source-bucket-demo-2025 --force
aws s3 rb s3://my-destination-bucket-demo-2025 --force
aws sns delete-topic --topic-arn $SNS_ARN
aws lambda delete-function --function-name s3-to-sns-move
aws iam detach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
aws iam detach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
aws iam detach-role-policy --role-name lambda-s3-sns-role --policy-arn arn:aws:iam::aws:policy/AmazonSNSFullAccess
aws iam delete-role --role-name lambda-s3-sns-role
```


