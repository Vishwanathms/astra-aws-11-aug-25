
# **Lab: Deploy Lambda Triggered by S3 Upload**

## **Objective**

Set up an **AWS Lambda** function that runs automatically whenever a new object is uploaded to a specific S3 bucket.

---

## **1. Prerequisites**

* AWS account with:

  * Permissions for S3, Lambda, IAM, and CloudWatch
* AWS CLI installed & configured (`aws configure`)
* Basic familiarity with Python or Node.js (we’ll use Python here)

---

## **2. Architecture**

1. **S3 bucket** → stores uploaded files.
2. **S3 Event Notification** → triggers Lambda on `s3:ObjectCreated:*`.
3. **Lambda Function** → processes file metadata and logs it.
4. **CloudWatch Logs** → stores Lambda execution logs.

---

## **3. Steps**

### **Step 1 — Create the S3 Bucket**

```bash
aws s3 mb s3://my-upload-trigger-bucket-2025
```

* Bucket name must be globally unique.

---

### **Step 2 — Create the Lambda IAM Role**

1. Create the trust policy file (`trust-policy.json`):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

2. Create the role:

```bash
aws iam create-role \
  --role-name LambdaS3ExecutionRole \
  --assume-role-policy-document file://trust-policy.json
```

3. Attach permissions:

```bash
aws iam attach-role-policy \
  --role-name LambdaS3ExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

aws iam attach-role-policy \
  --role-name LambdaS3ExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```

---

### **Step 3 — Create the Lambda Function**

1. Save this Python code as `lambda_function.py`:

```python
import json

def lambda_handler(event, context):
    print("Event:", json.dumps(event))
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']
    print(f"New file uploaded: s3://{bucket}/{key}")
    return {
        'statusCode': 200,
        'body': f"Processed file {key} from bucket {bucket}"
    }
```

2. Package and deploy:

```bash
zip function.zip lambda_function.py
aws lambda create-function \
  --function-name S3UploadTrigger \
  --runtime python3.9 \
  --role arn:aws:iam::<ACCOUNT_ID>:role/LambdaS3ExecutionRole \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://function.zip
```

---

### **Step 4 — Give S3 Permission to Invoke Lambda**

```bash
aws lambda add-permission \
  --function-name S3UploadTrigger \
  --principal s3.amazonaws.com \
  --statement-id s3invoke \
  --action "lambda:InvokeFunction" \
  --source-arn arn:aws:s3:::my-upload-trigger-bucket-2025
```

---

### **Step 5 — Add the Event Notification to S3**

```bash
aws s3api put-bucket-notification-configuration \
  --bucket my-upload-trigger-bucket-2025 \
  --notification-configuration '{
    "LambdaFunctionConfigurations": [
      {
        "LambdaFunctionArn": "arn:aws:lambda:<REGION>:<ACCOUNT_ID>:function:S3UploadTrigger",
        "Events": ["s3:ObjectCreated:*"]
      }
    ]
  }'
```

---

### **Step 6 — Test the Setup**

1. Upload a file:

```bash
aws s3 cp test.txt s3://my-upload-trigger-bucket-2025/
```

2. Check Lambda logs:

```bash
aws logs describe-log-groups
aws logs get-log-events \
  --log-group-name "/aws/lambda/S3UploadTrigger" \
  --log-stream-name "<stream_name>"
```

You should see:

```
New file uploaded: s3://my-upload-trigger-bucket-2025/test.txt
```

---

✅ **End Result:**
Any file uploaded to `my-upload-trigger-bucket-2025` will automatically invoke your Lambda function.

